# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Use a package of configuration called an orb.
orbs:
  docsync: streamroot/docsync@1.0.2
# Orchestrate or schedule a set of jobs
jobs:
    build:
        docker:
            - image: alpine/git
        parameters:
            github-repo-name:
                description: Target Project
                type: env_var_name
                default: GITHUB_REPO_NAME
            github-repo-url:
                description: Target Project URL
                type: env_var_name
                default: GITHUB_REPO_URL
            github-user-name:
                description: Username of GitHub account
                type: env_var_name
                default: GITHUB_USER_NAME
            github-personnal-token:
                description: GITHUB Token
                type: env_var_name
                default: GITHUB_PERSONAL_TOKEN
        steps:
        - checkout
        #- docsync/sync-to-doc-repo
        - run:
            name: Trigger docs deployment if doc is modified
            command: |
                # workaround while VAR expansion in working_directory has issue
                curr_pwd=`pwd`
                cd ~/workdir/${<<parameters.github-repo-name>>}
                git add -A
                if git diff-index --quiet HEAD --; then
                    echo "No docs changes detected..."
                else
                    # Push quietly to prevent showing the token in log
                    git commit -m "Commit from $CIRCLE_PROJECT_REPONAME from commit $CIRCLE_SHA1"
                    git push -q https://${<<parameters.github-personnal-token>>}@${<<parameters.github-repo-url>>}
                fi
                cd $curr_pwd